<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trang Tu Tập Nâng Cấp</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome for icons -->
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <!-- Google Fonts - Inter for a modern look -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Custom selection style */
    ::selection {
      background: gold;
      color: black;
    }

    /* Active state for Table of Contents links */
    .toc-active {
      font-weight: bold;
      color: #f59e0b; /* Tailwind yellow-500 */
    }

    /* Rain heart animation for like button */
    .rain-heart {
      position: absolute;
      animation: fall 1s ease-out forwards;
      pointer-events: none; /* Allow clicks to pass through */
      z-index: 10000; /* Ensure hearts are on top */
    }

    @keyframes fall {
      0% {
        opacity: 1;
        transform: translateY(-10px) scale(1);
      }
      100% {
        opacity: 0;
        transform: translateY(100px) scale(0.5);
      }
    }

    /* Highlight for search functionality */
    .highlight {
      background-color: yellow;
      padding: 2px 0;
    }

    /* Highlight for current reading paragraph */
    .highlight-paragraph {
      background-color: #fffacd; /* Light yellow for highlighting */
      transition: background-color 0.3s ease;
      padding: 0.25em 0.5em; /* Add some padding for better visual */
      border-radius: 0.25em; /* Rounded corners for highlight */
      display: block; /* Ensure it takes full width */
    }

    /* Dark mode adjustment for highlight */
    body.dark .highlight-paragraph {
      background-color: #3a3f4a; /* Darker shade for contrast in dark mode */
    }

    /* Smooth scroll behavior */
    html {
      scroll-behavior: smooth;
    }

    /* Apply Inter font globally */
    body {
      font-family: 'Inter', sans-serif;
    }

    /* Dark mode styles (applied on top of themes) */
    body.dark {
      background-color: #1a202c; /* Tailwind gray-900 */
      color: #e2e8f0; /* Tailwind gray-200 */
    }

    body.dark .bg-white {
      background-color: #2d3748; /* Tailwind gray-800 */
    }

    body.dark .text-gray-900 {
      color: #e2e8f0;
    }

    body.dark .bg-yellow-200 {
      background-color: #4a5568; /* Tailwind gray-700 */
    }

    body.dark .text-yellow-900 {
      color: #f6e05e; /* Tailwind yellow-300 */
    }
    
    body.dark .bg-gray-50 { /* Adjust for dark mode TOC */
      background-color: #2d3748;
    }

    body.dark .bg-gray-200 {
      background-color: #4a5568;
      color: #e2e8f0;
    }

    body.dark .bg-gray-300 {
      background-color: #6a7382;
    }

    body.dark #shareModal > div {
      background-color: #2d3748;
    }

    /* --- Define CSS Variables for Dynamic Theming --- */
    :root {
      --main-border-color: #f59e0b; /* Default: yellow-500 */
      --glowing-shadow-color: rgba(252, 211, 77, 0.4); /* Default: yellow-300 with alpha */
      --content-bg-color: #ffffff; /* Default: white */
      --content-text-color: #1f2937; /* Default: gray-900 */
      --header-bg-color: #fef08a; /* Default: yellow-200 */
      --header-text-color: #92400e; /* Default: yellow-900 */
      --toc-bg-color: #f9fafb; /* Default: gray-50 */
      --button-bg-blue: #2563eb; /* Default: blue-600 */
      --button-hover-blue: #1d4ed8; /* Default: blue-700 */
      --button-bg-pink: #ec4899; /* Default: pink-500 */
      --button-hover-pink: #db2777; /* Default: pink-600 */
      --button-bg-gray: #e5e7eb; /* Default: gray-200 */
      --button-hover-gray: #d1d5db; /* Default: gray-300 */
      --button-text-gray: #1f2937; /* Default: gray-800 */
      --button-bg-green: #22c55e; /* Default: green-500 */
      --button-hover-green: #16a34a; /* Default: green-600 */
      --button-bg-dark: #374151; /* Default: gray-700 */
      --button-hover-dark: #1f2937; /* Default: gray-800 */
      --input-border-color: #d1d5db; /* Default: gray-300 */
      --input-focus-ring: #f59e0b; /* Default: yellow-500 */
    }

    /* Dark mode variables */
    body.dark {
      --main-border-color: #fcd34d; /* yellow-300 */
      --glowing-shadow-color: rgba(251, 191, 36, 0.3); /* yellow-500 with alpha */
      --content-bg-color: #2d3748; /* gray-800 */
      --content-text-color: #e2e8f0; /* gray-200 */
      --header-bg-color: #4a5568; /* gray-700 */
      --header-text-color: #f6e05e; /* yellow-300 */
      --toc-bg-color: #2d3748; /* gray-800 */
      --button-bg-blue: #3b82f6; /* blue-500 */
      --button-hover-blue: #2563eb; /* blue-600 */
      --button-bg-pink: #fb7185; /* pink-400 */
      --button-hover-pink: #f43f5e; /* pink-500 */
      --button-bg-gray: #4a5568; /* gray-700 */
      --button-hover-gray: #6a7382; /* gray-600 */
      --button-text-gray: #e2e8f0; /* gray-200 */
      --button-bg-green: #34d399; /* green-400 */
      --button-hover-green: #10b981; /* green-500 */
      --button-bg-dark: #e2e8f0; /* gray-200 */
      --button-hover-dark: #cbd5e0; /* gray-300 */
      --input-border-color: #4a5568; /* gray-700 */
      --input-focus-ring: #f6e05e; /* yellow-300 */
    }

    /* Xanh Lục Tĩnh Lặng */
    body.theme-green {
      --main-border-color: #48bb78; /* green-500 */
      --glowing-shadow-color: rgba(76, 209, 140, 0.3); /* green-400 with alpha */
      --content-bg-color: #d4f0f0;
      --content-text-color: #2f4f4f;
      --header-bg-color: #a7d9d9;
      --header-text-color: #2f4f4f;
      --toc-bg-color: #c0e0e0;
      --button-bg-blue: #6495ed;
      --button-hover-blue: #4169e1;
      --button-bg-pink: #ffb6c1;
      --button-hover-pink: #ff8c9a;
      --button-bg-gray: #80ced6;
      --button-hover-gray: #66b2b2;
      --button-text-gray: #2f4f4f;
      --button-bg-green: #3cb371;
      --button-hover-green: #2e8b57;
      --button-bg-dark: #5f9ea0;
      --button-hover-dark: #4682b4;
      --input-border-color: #80ced6;
      --input-focus-ring: #48bb78;
    }
    body.theme-green.dark { /* Dark mode for green theme */
      --main-border-color: #68d391; /* green-400 */
      --glowing-shadow-color: rgba(76, 209, 140, 0.2);
      --content-bg-color: #2d483a; /* Darker green shade */
      --content-text-color: #e0f2e0;
      --header-bg-color: #3a5f4a;
      --header-text-color: #90ee90;
      --toc-bg-color: #2a3a2d;
      --button-bg-blue: #4682b4;
      --button-hover-blue: #366792;
      --button-bg-pink: #ff69b4;
      --button-hover-pink: #ff1493;
      --button-bg-gray: #3a5f4a;
      --button-hover-gray: #4a705a;
      --button-text-gray: #e0f2e0;
      --button-bg-green: #2e8b57;
      --button-hover-green: #1e6b3f;
      --button-bg-dark: #e0f2e0;
      --button-hover-dark: #c0e0c0;
      --input-border-color: #3a5f4a;
      --input-focus-ring: #68d391;
    }


    /* Tím Thiền Định */
    body.theme-purple {
      --main-border-color: #9f7aea; /* purple-500 */
      --glowing-shadow-color: rgba(164, 116, 252, 0.3); /* purple-400 with alpha */
      --content-bg-color: #e8d0f2;
      --content-text-color: #4b0082;
      --header-bg-color: #d8bfd8;
      --header-text-color: #4b0082;
      --toc-bg-color: #e6cce6;
      --button-bg-blue: #8a2be2;
      --button-hover-blue: #6a0dad;
      --button-bg-pink: #ff69b4;
      --button-hover-pink: #ff1493;
      --button-bg-gray: #b0e0e6;
      --button-hover-gray: #92c9d2;
      --button-text-gray: #4b0082;
      --button-bg-green: #8a2be2; /* Using purple for green contrast */
      --button-hover-green: #6a0dad;
      --button-bg-dark: #9370db;
      --button-hover-dark: #7b68ee;
      --input-border-color: #b0e0e6;
      --input-focus-ring: #9f7aea;
    }
    body.theme-purple.dark { /* Dark mode for purple theme */
      --main-border-color: #b794f4; /* purple-400 */
      --glowing-shadow-color: rgba(164, 116, 252, 0.2);
      --content-bg-color: #4a3068; /* Darker purple shade */
      --content-text-color: #f0e6ff;
      --header-bg-color: #3a2048;
      --header-text-color: #d8bfd8;
      --toc-bg-color: #2a183a;
      --button-bg-blue: #6a0dad;
      --button-hover-blue: #480082;
      --button-bg-pink: #ff1493;
      --button-hover-pink: #c71585;
      --button-bg-gray: #3a2048;
      --button-hover-gray: #4a285a;
      --button-text-gray: #f0e6ff;
      --button-bg-green: #6a0dad;
      --button-hover-green: #480082;
      --button-bg-dark: #f0e6ff;
      --button-hover-dark: #d8cce6;
      --input-border-color: #3a2048;
      --input-focus-ring: #b794f4;
    }

    /* Vàng Nhẹ Thoát Tục */
    body.theme-gold {
      --main-border-color: #d69e2e; /* yellow-700 */
      --glowing-shadow-color: rgba(253, 230, 138, 0.4); /* yellow-200 with alpha */
      --content-bg-color: #fff5e0;
      --content-text-color: #5a4a3a;
      --header-bg-color: #ffe4b5;
      --header-text-color: #5a4a3a;
      --toc-bg-color: #fffacd;
      --button-bg-blue: #add8e6;
      --button-hover-blue: #87ceeb;
      --button-bg-pink: #ffc0cb;
      --button-hover-pink: #ff8c9a;
      --button-bg-gray: #f0e68c;
      --button-hover-gray: #e6e6a8;
      --button-text-gray: #5a4a3a;
      --button-bg-green: #b8860b;
      --button-hover-green: #a0522d;
      --button-bg-dark: #daa520;
      --button-hover-dark: #b8860b;
      --input-border-color: #f0e68c;
      --input-focus-ring: #d69e2e;
    }
    body.theme-gold.dark { /* Dark mode for gold theme */
      --main-border-color: #f6e05e; /* yellow-300 */
      --glowing-shadow-color: rgba(253, 230, 138, 0.2);
      --content-bg-color: #4a3a2d; /* Darker gold/brown shade */
      --content-text-color: #fffaf0;
      --header-bg-color: #3a2d20;
      --header-text-color: #ffe4b5;
      --toc-bg-color: #2a2018;
      --button-bg-blue: #5f9ea0;
      --button-hover-blue: #4682b4;
      --button-bg-pink: #ff8c9a;
      --button-hover-pink: #ff1493;
      --button-bg-gray: #3a2d20;
      --button-hover-gray: #4a3a2d;
      --button-text-gray: #fffaf0;
      --button-bg-green: #a0522d;
      --button-hover-green: #8b4513;
      --button-bg-dark: #fffaf0;
      --button-hover-dark: #ffe4b5;
      --input-border-color: #3a2d20;
      --input-focus-ring: #f6e05e;
    }

    /* Apply styles to content */
    #content {
      border: 2px solid var(--main-border-color);
      border-radius: 1.5rem; /* 24px */
      box-shadow:
        inset 0 0 0 1px rgba(255, 255, 255, 0.3), /* Inner light border */
        0 10px 15px -3px rgba(0, 0, 0, 0.1), /* Near blur shadow */
        0 4px 6px -2px rgba(0, 0, 0, 0.05), /* Near blur shadow */
        0 0 20px 5px var(--glowing-shadow-color); /* Far glowing shadow */
      backdrop-filter: blur(15px); /* Glassmorphism effect */
      background-color: var(--content-bg-color); /* Use variable for background */
      color: var(--content-text-color); /* Use variable for text color */
      transition: all 0.5s ease-in-out; /* Smooth transition for theme changes */
    }

    /* Adjust prose styles for better compatibility with themes */
    #content.prose h1, #content.prose h2, #content.prose strong {
        color: inherit; /* Inherit text color from body/theme */
    }

    /* General button styling for consistency */
    button {
        background-color: var(--button-bg-blue); /* Default button color */
        color: white;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        transition: background-color 0.2s ease-in-out, transform 0.1s ease-out;
    }
    button:hover {
        transform: translateY(-1px);
    }
    button:active {
        transform: translateY(0);
    }

    /* Specific button overrides */
    #readBtn { background-color: var(--button-bg-blue); }
    #readBtn:hover { background-color: var(--button-hover-blue); }
    #likeBtn { background-color: var(--button-bg-pink); }
    #likeBtn:hover { background-color: var(--button-hover-pink); }
    #shareBtn {
        background-color: var(--button-bg-gray);
        color: var(--button-text-gray);
    }
    #shareBtn:hover { background-color: var(--button-hover-gray); }
    #searchBtn { background-color: var(--button-bg-green); }
    #searchBtn:hover { background-color: var(--button-hover-green); }
    #darkModeToggle { background-color: var(--button-bg-dark); }
    #darkModeToggle:hover { background-color: var(--button-hover-dark); }
    #scrollTopBtn, #scrollBottomBtn {
        background-color: var(--main-border-color); /* Use main theme color for scroll buttons */
    }
    #scrollTopBtn:hover, #scrollBottomBtn:hover {
        background-color: var(--glowing-shadow-color); /* Use glowing color for hover */
    }

    /* Input and Select styling */
    input[type="text"], select {
        border-color: var(--input-border-color);
        background-color: var(--content-bg-color);
        color: var(--content-text-color);
    }
    input[type="text"]:focus, select:focus {
        border-color: var(--input-focus-ring);
        box-shadow: 0 0 0 2px var(--input-focus-ring);
    }

  </style>
</head>

<body class="bg-white text-gray-900 transition-all duration-300">
  <!-- Scroll Progress Bar -->
  <div id="scrollProgress" class="fixed top-0 left-0 h-1 bg-yellow-400 z-[9999]" style="width: 0%;"></div>

  <!-- Navigation Header -->
  <header class="bg-yellow-200 shadow sticky top-0 z-50 rounded-b-lg" style="background-color: var(--header-bg-color);">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <!-- Logo and Site Title -->
      <a href="#" class="flex items-center space-x-2 text-xl font-bold text-yellow-900" 
         onclick="window.scrollTo({ top: 0, behavior: 'smooth' }); return false;"
         style="color: var(--header-text-color);">
        <img src="https://raw.githubusercontent.com/thiensutinhquang/Admin/main/icons/icon.png" alt="Logo Giáo Lý MSTQ" class="h-8 w-auto rounded-full">
        <span>Giáo Lý MSTQ</span>
      </a>
      <nav class="hidden md:flex space-x-4 text-sm">
        <a href="#" class="hover:underline p-2 rounded-lg hover:bg-yellow-300 transition-colors duration-200">Trang chủ</a>
        <a href="#" class="hover:underline p-2 rounded-lg hover:bg-yellow-300 transition-colors duration-200">Play Nhạc</a>
        <a href="#" class="hover:underline p-2 rounded-lg hover:bg-yellow-300 transition-colors duration-200">Kho Thơ</a>
        <a href="#" class="hover:underline p-2 rounded-lg hover:bg-yellow-300 transition-colors duration-200">Play Video</a>
        <a href="https://facebook.com" target="_blank" class="hover:underline p-2 rounded-lg hover:bg-yellow-300 transition-colors duration-200">Facebook</a>
        <a href="https://youtube.com" target="_blank" class="hover:underline p-2 rounded-lg hover:bg-yellow-300 transition-colors duration-200">YouTube</a>
      </nav>
      <button id="menuToggle" class="md:hidden text-yellow-900 p-2 rounded-lg hover:bg-yellow-300 transition-colors duration-200" style="color: var(--header-text-color);">
        <i class="fas fa-bars text-2xl"></i>
      </button>
    </div>
  </header>

  <!-- Mobile Menu -->
  <div id="mobileMenu" class="fixed inset-0 bg-white z-[999] p-6 hidden flex-col space-y-4 rounded-lg shadow-lg">
    <button id="closeMenu" class="self-end text-yellow-900 p-2 rounded-lg hover:bg-yellow-100 transition-colors duration-200" style="color: var(--header-text-color);"><i class="fas fa-times text-2xl"></i></button>
    <a href="#" class="hover:underline p-2 rounded-lg hover:bg-yellow-100 transition-colors duration-200">Trang chủ</a>
    <a href="#" class="hover:underline p-2 rounded-lg hover:bg-yellow-100 transition-colors duration-200">Play Nhạc</a>
    <a href="#" class="hover:underline p-2 rounded-lg hover:bg-yellow-100 transition-colors duration-200">Kho Thơ</a>
    <a href="#" class="hover:underline p-2 rounded-lg hover:bg-yellow-100 transition-colors duration-200">Play Video</a>
    <a href="https://facebook.com" target="_blank" class="hover:underline p-2 rounded-lg hover:bg-yellow-100 transition-colors duration-200">Facebook</a>
    <a href="https://youtube.com" target="_blank" class="hover:underline p-2 rounded-lg hover:bg-yellow-100 transition-colors duration-200">YouTube</a>
  </div>

  <!-- Table of Contents (TOC) -->
  <aside class="hidden lg:block fixed left-4 top-24 w-56 text-sm bg-gray-50 p-4 rounded-lg shadow-md" id="toc" style="background-color: var(--toc-bg-color);">
    <h3 class="font-bold text-lg mb-2 text-yellow-800" style="color: var(--header-text-color);">Mục Lục</h3>
    <!-- TOC links will be dynamically inserted here -->
  </aside>

  <main class="container mx-auto px-4 py-8 max-w-3xl relative">
    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
      <div class="flex gap-2">
        <button id="readBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 shadow-md">
          🔊 Đọc bài
        </button>
        <button id="likeBtn" class="relative px-4 py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600 transition-colors duration-200 shadow-md">
          ❤️ <span id="likeCount">0</span>
        </button>
        <button id="shareBtn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors duration-200 shadow-md">
          📤 Chia sẻ
        </button>
      </div>
      <div class="flex gap-2 items-center">
        <input type="text" id="searchBox" placeholder="Tìm kiếm..." class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 transition-all duration-200 w-full sm:w-auto">
        <button id="searchBtn" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors duration-200 shadow-md">
          🔍
        </button>
        <select id="themeSelector" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 transition-all duration-200">
          <option value="default">Mặc định</option>
          <option value="green">Xanh Lục Tĩnh Lặng</option>
          <option value="purple">Tím Thiền Định</option>
          <option value="gold">Vàng Nhẹ Thoát Tục</option>
        </select>
        <button id="darkModeToggle" class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800 transition-colors duration-200 shadow-md">
          🌙
        </button>
      </div>
    </div>

    <!-- Main Content Area -->
    <div id="content" class="prose lg:prose-lg max-w-none bg-white p-6 rounded-lg shadow-xl">
      <h1 id="section-0">Ánh sáng và sự sống trong tu tập</h1>
      <p><strong>Mở đầu:</strong> Trong muôn loài vạn vật, ánh sáng chính là nguồn gốc của sự sống, là yếu tố thiết yếu nuôi dưỡng mọi sinh linh. Từ ánh nắng mặt trời rực rỡ ban ngày đến ánh trăng dịu mát đêm về, hay ánh sao lấp lánh trên bầu trời, tất cả đều mang theo một thông điệp về sự tồn tại, về năng lượng và sự phát triển. Trong con đường tu tập tâm linh, ánh sáng không chỉ là một hiện tượng vật lý mà còn là biểu tượng sâu sắc cho trí tuệ, sự giác ngộ và năng lượng thiêng liêng. Nó là kim chỉ nam dẫn lối, là nguồn sức mạnh nội tại giúp người hành giả vượt qua mọi chướng ngại, hướng tới sự hoàn thiện.</p>

      <h2 id="section-1">Ánh sáng nội tâm: Nền tảng của sự giác ngộ</h2>
      <p>Khi người hành giả bước vào con đường tu học, điều đầu tiên cần nhận thức là tầm quan trọng của ánh sáng nội tâm. Ánh sáng này không phải là thứ có thể nhìn thấy bằng mắt thường, mà là sự minh triết, sự hiểu biết sâu sắc về bản chất của vạn vật và về chính mình. Nó là sự thức tỉnh của lương tri, là khả năng phân biệt thiện ác, đúng sai, là sự nhận diện chân lý trong từng hơi thở, từng ý niệm. Việc nuôi dưỡng ánh sáng nội tâm đòi hỏi sự kiên trì, tinh tấn trong thiền định, quán chiếu và thực hành giới luật. Mỗi khi một phiền não được hóa giải, một chấp trước được buông bỏ, ánh sáng trong tâm lại càng rực rỡ hơn, soi rọi rõ ràng hơn con đường phía trước.</p>

      <h2 id="section-2">Vượt qua bóng tối: Những chướng ngại trên con đường tu</h2>
      <p>Thiếu ánh sáng, con đường tu trở nên mờ mịt, đầy rẫy những cạm bẫy và thử thách. Bóng tối ở đây không chỉ là sự vô minh, mà còn là những tham lam, sân hận, si mê, là những dục vọng trần tục níu kéo. Khi tâm trí bị che phủ bởi bóng tối, người tu dễ dàng lạc lối, mất phương hướng, thậm chí từ bỏ con đường đã chọn. Những lúc như vậy, ánh sáng của chánh pháp, ánh sáng từ sự hướng dẫn của Minh Sư, và ánh sáng từ sự kiên định của chính mình trở thành ngọn hải đăng, giúp người hành giả vượt qua bão tố. Việc đối diện và chuyển hóa bóng tối là một phần không thể thiếu của quá trình tu tập, bởi chỉ khi vượt qua được những giới hạn của bản thân, ánh sáng mới có thể tỏa rạng một cách trọn vẹn.</p>

      <h2 id="section-3">Pháp môn Minh Sư Tịnh Quang: Nguồn sáng dẫn lối</h2>
      <p>Trong Pháp môn Minh Sư Tịnh Quang, ánh sáng được xem là một yếu tố cốt lõi, là phương tiện để đạt đến sự thanh tịnh và giác ngộ. Minh Sư, với trí tuệ và lòng từ bi vô hạn, chính là hiện thân của ánh sáng, là người thầy dẫn dắt chúng sinh thoát khỏi vô minh. Pháp môn này nhấn mạnh việc tu tập để khai mở "Tịnh Quang" – ánh sáng thanh tịnh bên trong mỗi người. Thông qua việc thực hành các pháp môn đặc thù, người tu học được tiếp nhận và dung hòa ánh sáng từ Minh Sư, từ đó làm tăng trưởng ánh sáng nội tâm của chính mình. Sự kết nối với Tịnh Quang không chỉ giúp thanh lọc thân tâm mà còn mở ra những tầng nhận thức cao hơn, đưa người hành giả đến gần hơn với chân lý tối thượng.</p>

      <h2 id="section-4">Sự sống mới: Kết quả của ánh sáng tu tập</h2>
      <p>Khi ánh sáng nội tâm được nuôi dưỡng và phát triển, nó không chỉ mang lại sự bình an, hạnh phúc cho bản thân mà còn lan tỏa ra xung quanh, ảnh hưởng tích cực đến cuộc sống của những người khác. Sự sống trong tu tập không chỉ là sự tồn tại về mặt thể xác, mà là một cuộc sống tràn đầy ý nghĩa, mục đích và lòng từ bi. Người tu học với ánh sáng rực rỡ trong tâm sẽ trở thành nguồn cảm hứng, là tấm gương sáng cho cộng đồng. Họ sống một cuộc đời vị tha, cống hiến, và luôn hướng đến sự thiện lành. Đây chính là biểu hiện cao nhất của sự sống được nuôi dưỡng bởi ánh sáng của trí tuệ và tình yêu thương.</p>

      <p><strong>Kết luận:</strong> Hãy gìn giữ và nuôi dưỡng ánh sáng trong tâm, bởi đó là nguồn gốc của mọi sự sống và là con đường dẫn đến sự giác ngộ viên mãn. Ánh sáng không chỉ là biểu tượng mà còn là năng lượng thực sự, giúp chúng ta vượt qua bóng tối vô minh, sống một cuộc đời ý nghĩa và lan tỏa yêu thương đến muôn nơi. Pháp môn Minh Sư Tịnh Quang chính là chiếc thuyền đưa chúng ta đến bến bờ giác ngộ, nơi ánh sáng vĩnh cửu soi rọi mọi ngóc ngách của tâm hồn.</p>
    </div>
  </main>

  <!-- Share Modal -->
  <div id="shareModal" class="fixed inset-0 bg-black/40 flex justify-center items-center z-[9999] hidden">
    <div class="bg-white p-6 rounded-lg shadow-xl w-80">
      <h2 class="text-lg font-bold mb-4 text-gray-800">Chia sẻ</h2>
      <div class="flex flex-col gap-3 mb-4">
        <a href="#" id="shareFacebook" target="_blank" class="flex items-center gap-2 text-blue-600 hover:underline p-2 rounded-lg hover:bg-blue-50 transition-colors duration-200">
          <i class="fab fa-facebook-f"></i> Facebook
        </a>
        <button id="copyLinkBtn" class="flex items-center gap-2 text-green-600 hover:underline p-2 rounded-lg hover:bg-green-50 transition-colors duration-200 justify-start">
          <i class="fas fa-link"></i> Sao chép liên kết
        </button>
      </div>
      <button id="closeShare" class="block mx-auto bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors duration-200 shadow-md">Đóng</button>
    </div>
  </div>

  <!-- Message Box for copy confirmation -->
  <div id="messageBox" class="fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg hidden z-[10000]">
    Đã sao chép vào clipboard!
  </div>

  <!-- Floating Scroll Buttons -->
  <div class="fixed right-4 top-1/2 -translate-y-1/2 flex flex-col gap-2 z-40">
    <button id="scrollTopBtn" class="p-3 bg-yellow-500 text-white rounded-full shadow-lg hover:bg-yellow-600 transition-colors duration-200">
      <i class="fas fa-arrow-up"></i>
    </button>
    <button id="scrollBottomBtn" class="p-3 bg-yellow-500 text-white rounded-full shadow-lg hover:bg-yellow-600 transition-colors duration-200">
      <i class="fas fa-arrow-down"></i>
    </button>
  </div>

  <script type="module">
    // Firebase imports (using modular SDK)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global variables for Firebase config and auth token
    const firebaseConfig = {
      apiKey: "AIzaSyCWv6m3Vw76HPYSRd96U847qViV_EJXZ0Q",
      authDomain: "giaolylikes.firebaseapp.com",
      projectId: "giaolylikes",
      storageBucket: "giaolylikes.firebasestorage.app",
      messagingSenderId: "580748260318",
      appId: "1:580748260318:web:0922e75d385ccab02fa34f"
    };

    const appId = firebaseConfig.projectId;
    const initialAuthToken = null;

    let app, db, auth, userId;
    const ARTICLE_ID = 'mainArticleLikes';
    let currentLikeCount = 0;

    // Log Firebase Config and App ID for debugging
    console.log("Firebase Config:", firebaseConfig);
    console.log("App ID for Firestore paths:", appId);

    // --- Helper Functions (Defined before they are called) ---

    // Message Box Display
    function showMessageBox(message) {
      const messageBox = document.getElementById('messageBox');
      if (messageBox) {
        messageBox.textContent = message;
        messageBox.classList.remove('hidden');
        setTimeout(() => {
          messageBox.classList.add('hidden');
        }, 3000);
      } else {
        console.warn("Message box element not found.");
      }
    }

    // Clear highlights for search functionality
    let lastHighlightedRanges = [];

    function clearHighlights() {
      const content = document.getElementById('content');
      if (content) {
        const highlights = content.querySelectorAll('.highlight');
        highlights.forEach(span => {
          const parent = span.parentNode;
          while (span.firstChild) {
            parent.insertBefore(span.firstChild, span);
          }
          parent.removeChild(span);
        });
        content.normalize();
        lastHighlightedRanges = [];
      }
    }

    // Apply Theme Logic
    const themes = ['default', 'green', 'purple', 'gold'];

    const applyTheme = (themeName) => {
      themes.forEach(theme => {
        document.body.classList.remove(`theme-${theme}`);
      });
      if (themeName !== 'default') {
        document.body.classList.add(`theme-${themeName}`);
      }
      localStorage.setItem('selectedTheme', themeName);
    };

    // Text-to-Speech Helper Functions
    let speechSynthesizer = null;
    let paragraphElements = [];
    let currentParagraphIndex = 0;
    let currentUtterance = null;
    let isSpeechReady = false;

    function initializeParagraphElements() {
      const content = document.getElementById('content');
      if (content) {
        paragraphElements = Array.from(content.querySelectorAll('h1, h2, p'));
      }
    }

    const initSpeechSynthesis = () => {
      speechSynthesizer = window.speechSynthesis;
      const readBtn = document.getElementById('readBtn');
      if (!speechSynthesizer) {
        console.warn("SpeechSynthesis not supported in this browser.");
        showMessageBox("Trình duyệt của bạn không hỗ trợ đọc văn bản.");
        if (readBtn) readBtn.disabled = true;
        return;
      }

      const checkVoices = () => {
        const voices = speechSynthesis.getVoices();
        console.log("Checking voices. Found:", voices.length, "voices.");
        if (voices.length > 0) {
          isSpeechReady = true;
          console.log("SpeechSynthesis is ready.");
          if (readBtn) readBtn.disabled = false;
          showMessageBox("Hệ thống đọc bài đã sẵn sàng.");
          return true;
        }
        return false;
      };

      // Initial check
      if (checkVoices()) {
        return;
      }

      // Listen for voices to be loaded
      speechSynthesizer.onvoiceschanged = () => {
        console.log("SpeechSynthesis voices changed event fired.");
        checkVoices(); // Re-check voices when they change
      };

      // Polling mechanism as a fallback if onvoiceschanged doesn't fire or voices are slow to load
      let voiceCheckInterval = setInterval(() => {
        if (checkVoices()) {
          clearInterval(voiceCheckInterval);
        } else {
          console.log("Polling for voices... Still not ready.");
        }
      }, 500);

      // Set a timeout to stop polling after some time if voices don't load
      setTimeout(() => {
        if (!isSpeechReady) {
          clearInterval(voiceCheckInterval);
          console.warn("SpeechSynthesis voices not loaded after timeout.");
          showMessageBox("Không thể tải giọng đọc. Vui lòng thử lại hoặc kiểm tra cài đặt giọng nói của trình duyệt/hệ điều hành.");
          if (readBtn) readBtn.disabled = true;
        }
      }, 15000); // Increased timeout to 15 seconds
    };

    function clearAllHighlightsForSpeech() { // Renamed to avoid conflict with search highlight clear
      paragraphElements.forEach(el => el.classList.remove('highlight-paragraph'));
    }

    function stopReading() {
      const readBtn = document.getElementById('readBtn');
      if (speechSynthesizer && readBtn) {
        speechSynthesizer.cancel();
      }
      clearAllHighlightsForSpeech();
      currentParagraphIndex = 0;
      if (readBtn) readBtn.textContent = '🔊 Đọc bài';
      console.log("Reading stopped. Resetting button and highlights.");
    }

    function startReading() {
      const readBtn = document.getElementById('readBtn');
      clearAllHighlightsForSpeech();

      if (!isSpeechReady || !speechSynthesizer) {
        showMessageBox("Hệ thống đọc bài chưa sẵn sàng. Vui lòng thử lại sau.");
        console.error("Attempted to start reading when SpeechSynthesis was not ready.");
        if (readBtn) readBtn.disabled = true; // Ensure button is disabled if not ready
        return;
      }

      if (currentParagraphIndex >= paragraphElements.length) {
        console.log("End of article reached. Stopping reading.");
        stopReading();
        return;
      }

      const currentElement = paragraphElements[currentParagraphIndex];
      currentElement.classList.add('highlight-paragraph');
      currentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
      console.log(`Reading paragraph ${currentParagraphIndex}:`, currentElement.innerText.substring(0, 50) + "...");

      currentUtterance = new SpeechSynthesisUtterance(currentElement.innerText);

      const voices = speechSynthesizer.getVoices();
      const vietnameseVoice = voices.find(voice => voice.lang === 'vi-VN');
      if (vietnameseVoice) {
        currentUtterance.voice = vietnameseVoice;
        console.log("Using Vietnamese voice.");
      } else {
        console.warn("Vietnamese voice not found. Using default voice or first available voice.");
        // Fallback to first available voice if Vietnamese is not found
        if (voices.length > 0) {
            currentUtterance.voice = voices[0];
            console.log("Using first available voice:", voices[0].name);
        } else {
            console.error("No voices available at all, cannot speak.");
            showMessageBox("Không có giọng đọc nào khả dụng. Vui lòng kiểm tra cài đặt giọng nói của trình duyệt/hệ điều hành.");
            stopReading();
            return;
        }
      }

      currentUtterance.onend = () => {
        console.log(`Finished paragraph ${currentParagraphIndex}.`);
        currentElement.classList.remove('highlight-paragraph');
        currentParagraphIndex++;
        startReading();
      };

      currentUtterance.onerror = (event) => {
        console.error('SpeechSynthesisUtterance.onerror triggered:', event);
        console.error('Error details:', event.error); // More specific error detail
        stopReading();
        showMessageBox("Lỗi khi đọc bài viết. Vui lòng thử lại hoặc kiểm tra cài đặt giọng nói của trình duyệt.");
      };

      speechSynthesizer.speak(currentUtterance);
      if (readBtn) readBtn.textContent = '⏸️ Tạm dừng';
    }

    const updateTocActive = () => {
      const tocLinks = [];
      const headers = document.getElementById('content').querySelectorAll('h1, h2');
      headers.forEach((header, i) => {
        const id = 'section-' + i;
        const link = document.querySelector(`#toc a[href="#${id}"]`);
        if (link) {
          tocLinks.push({ id, link, element: header });
        }
      });

      let currentActive = null;
      for (let i = tocLinks.length - 1; i >= 0; i--) {
        const { element, link } = tocLinks[i];
        const rect = element.getBoundingClientRect();
        if (rect.top <= window.innerHeight / 2) {
          currentActive = link;
          break;
        }
      }
      tocLinks.forEach(({ link }) => link.classList.remove('toc-active'));
      if (currentActive) {
        currentActive.classList.add('toc-active');
      }
    };

    const setupLikesListener = () => {
      if (!db) {
        console.warn("Firestore not ready for likes listener.");
        return;
      }
      const articleRef = doc(db, `favorites`, ARTICLE_ID);
      console.log("Firestore listener path (read):", articleRef.path);

      onSnapshot(articleRef, (docSnap) => {
        const likeCountSpan = document.getElementById('likeCount');
        if (docSnap.exists()) {
          currentLikeCount = docSnap.data().likes || 0;
        } else {
          currentLikeCount = 0;
          setDoc(articleRef, { likes: 0 }, { merge: true }).catch(e => console.error("Error initializing likes document:", e));
        }
        if (likeCountSpan) likeCountSpan.textContent = currentLikeCount;
        console.log("Current like count:", currentLikeCount);
      }, (error) => {
        console.error("Error listening to likes:", error);
        showMessageBox("Lỗi khi tải số lượt thích. Vui lòng kiểm tra kết nối mạng.");
      });
    };


    // --- Initialize Firebase and handle authentication ---
    const initFirebase = async () => {
      try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        if (initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
          console.log("Signed in with custom token.");
        } else {
          await signInAnonymously(auth);
          console.log("Signed in anonymously.");
        }

        onAuthStateChanged(auth, (user) => {
          if (user) {
            userId = user.uid;
            console.log("User ID:", userId);
            setupLikesListener();
          } else {
            console.log("No user is signed in.");
            userId = null;
            setupLikesListener();
          }
        });
      } catch (error) {
        console.error("Error initializing Firebase or signing in:", error);
        showMessageBox("Lỗi khởi tạo Firebase. Vui lòng kiểm tra cấu hình API Key và các thông số khác.");
      }
    };

    initFirebase();


    // --- DOM Elements ---
    const menuToggle = document.getElementById('menuToggle');
    const mobileMenu = document.getElementById('mobileMenu');
    const closeMenu = document.getElementById('closeMenu');
    const toc = document.getElementById('toc');
    const content = document.getElementById('content');
    const scrollProgress = document.getElementById('scrollProgress');
    const readBtn = document.getElementById('readBtn');
    const likeBtn = document.getElementById('likeBtn');
    const likeCountSpan = document.getElementById('likeCount');
    const shareBtn = document.getElementById('shareBtn');
    const shareModal = document.getElementById('shareModal');
    const closeShare = document.getElementById('closeShare');
    const shareFacebook = document.getElementById('shareFacebook');
    const copyLinkBtn = document.getElementById('copyLinkBtn');
    const messageBox = document.getElementById('messageBox');
    const searchBox = document.getElementById('searchBox');
    const searchBtn = document.getElementById('searchBtn');
    const darkModeToggle = document.getElementById('darkModeToggle');
    const themeSelector = document.getElementById('themeSelector');
    const scrollTopBtn = document.getElementById('scrollTopBtn'); // Nút cuộn lên
    const scrollBottomBtn = document.getElementById('scrollBottomBtn'); // Nút cuộn xuống


    // --- Event Listeners ---

    if (menuToggle) menuToggle.onclick = () => mobileMenu.classList.remove('hidden');
    if (closeMenu) closeMenu.onclick = () => mobileMenu.classList.add('hidden');

    window.addEventListener('DOMContentLoaded', () => {
      initializeParagraphElements();
      initSpeechSynthesis(); // Call initSpeechSynthesis on DOMContentLoaded
      const headers = content.querySelectorAll('h1, h2');
      const tocLinksArray = [];
      headers.forEach((header, i) => {
        const id = 'section-' + i;
        header.id = id;
        const link = document.createElement('a');
        link.href = '#' + id;
        link.textContent = header.textContent;
        link.className = 'block py-1 px-2 rounded-md hover:bg-yellow-100 transition-colors duration-200';
        if (toc) toc.appendChild(link);
        tocLinksArray.push({ id, link, element: header });

        link.addEventListener('click', (e) => {
          e.preventDefault();
          header.scrollIntoView({ behavior: 'smooth' });
          setTimeout(() => updateTocActive(), 600);
        });
      });
    });

    window.onscroll = () => {
      if (scrollProgress) {
        const scrolled = (window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100;
        scrollProgress.style.width = scrolled + '%';
      }
      updateTocActive();
    };

    if (readBtn) {
      readBtn.onclick = () => {
        if (!isSpeechReady) {
          showMessageBox("Đang tải giọng đọc, vui lòng thử lại sau giây lát.");
          return;
        }
        if (speechSynthesizer.speaking && !speechSynthesizer.paused) {
          console.log("Pausing speech.");
          speechSynthesizer.pause();
          readBtn.textContent = '▶️ Tiếp tục';
          return;
        }
        if (speechSynthesizer.paused) {
          console.log("Resuming speech.");
          speechSynthesizer.resume();
          readBtn.textContent = '⏸️ Tạm dừng';
          return;
        }
        console.log("Starting speech.");
        startReading();
      };
    }

    if (likeBtn) {
      likeBtn.onclick = async (e) => {
        if (!db) {
          console.error("Firestore not initialized. Cannot update likes.");
          showMessageBox("Lỗi: Không thể kết nối đến máy chủ. Vui lòng kiểm tra cấu hình Firebase.");
          return;
        }
        const articleRef = doc(db, `favorites`, ARTICLE_ID);
        console.log("Firestore article likes path (write):", articleRef.path);

        try {
          await setDoc(articleRef, { likes: increment(1) }, { merge: true });
          console.log("Like count updated in Firestore.");
          const heart = document.createElement('div');
          heart.textContent = '❤️';
          heart.className = 'rain-heart';
          const rect = likeBtn.getBoundingClientRect();
          heart.style.left = (e.clientX - rect.left + likeBtn.offsetWidth / 2 - 10) + 'px';
          heart.style.top = (e.clientY - rect.top + likeBtn.offsetHeight / 2 - 10) + 'px';
          likeBtn.appendChild(heart);
          setTimeout(() => heart.remove(), 1000);
        } catch (error) {
          console.error("Error updating like count:", error);
          showMessageBox("Lỗi khi thích bài viết. Vui lòng kiểm tra quy tắc bảo mật Firestore và kết nối.");
        }
      };
    }

    if (shareBtn) {
      shareBtn.onclick = () => {
        if (shareModal) shareModal.classList.remove('hidden');
        const currentUrl = window.location.href;
        if (shareFacebook) shareFacebook.href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(currentUrl)}`;
      };
    }
    if (closeShare) closeShare.onclick = () => shareModal.classList.add('hidden');
    if (shareModal) {
      shareModal.addEventListener('click', (e) => {
        if (e.target === shareModal) {
          shareModal.classList.add('hidden');
        }
      });
    }

    if (copyLinkBtn) {
      copyLinkBtn.onclick = () => {
        const currentUrl = window.location.href;
        try {
          const tempInput = document.createElement('textarea');
          tempInput.value = currentUrl;
          document.body.appendChild(tempInput);
          tempInput.select();
          document.execCommand('copy');
          document.body.removeChild(tempInput);
          showMessageBox('Đã sao chép vào clipboard!');
          if (shareModal) shareModal.classList.add('hidden');
        } catch (err) {
          console.error('Failed to copy text: ', err);
          showMessageBox('Sao chép thất bại. Vui lòng sao chép thủ công.');
        }
      };
    }

    if (searchBtn) {
      searchBtn.onclick = () => {
        const searchTerm = searchBox.value.trim();
        if (searchTerm === '') {
          clearHighlights();
          return;
        }
        clearHighlights();
        const walker = document.createTreeWalker(content, NodeFilter.SHOW_TEXT, null, false);
        let node;
        let foundCount = 0;
        const rangesToHighlight = [];
        while ((node = walker.nextNode())) {
          const text = node.nodeValue;
          let startIndex = 0;
          while ((startIndex = text.toLowerCase().indexOf(searchTerm.toLowerCase(), startIndex)) !== -1) {
            const range = document.createRange();
            range.setStart(node, startIndex);
            range.setEnd(node, startIndex + searchTerm.length);
            rangesToHighlight.push(range);
            startIndex += searchTerm.length;
            foundCount++;
          }
        }
        if (foundCount > 0) {
          rangesToHighlight.forEach(range => {
            const span = document.createElement('span');
            span.classList.add('highlight');
            range.surroundContents(span);
          });
          lastHighlightedRanges = rangesToHighlight;
          showMessageBox(`Tìm thấy ${foundCount} kết quả.`);
        } else {
          showMessageBox('Không tìm thấy kết quả nào.');
        }
      };
    }

    if (searchBox) {
      searchBox.addEventListener('input', () => {
        if (searchBox.value.trim() === '') {
          clearHighlights();
        }
      });
    }

    if (darkModeToggle) {
      darkModeToggle.onclick = () => {
        document.body.classList.toggle('dark');
        if (document.body.classList.contains('dark')) {
          localStorage.setItem('theme', 'dark');
          darkModeToggle.innerHTML = '☀️';
        } else {
          localStorage.setItem('theme', 'light');
          darkModeToggle.innerHTML = '🌙';
        }
      };
    }

    window.addEventListener('DOMContentLoaded', () => {
      const savedTheme = localStorage.getItem('selectedTheme');
      if (savedTheme) {
        applyTheme(savedTheme);
        if (themeSelector) themeSelector.value = savedTheme;
      } else {
        applyTheme('default');
        if (themeSelector) themeSelector.value = 'default';
      }

      const savedDarkMode = localStorage.getItem('theme');
      if (savedDarkMode === 'dark') {
        document.body.classList.add('dark');
        if (darkModeToggle) darkModeToggle.innerHTML = '☀️';
      } else {
        if (darkModeToggle) darkModeToggle.innerHTML = '🌙';
      }
    });

    if (themeSelector) {
      themeSelector.onchange = (event) => {
        applyTheme(event.target.value);
      };
    }

    window.addEventListener('beforeunload', () => {
      if (speechSynthesizer && speechSynthesizer.speaking) {
        speechSynthesizer.cancel();
      }
    });

    // --- Floating Scroll Buttons Logic ---
    if (scrollTopBtn) {
      scrollTopBtn.onclick = () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      };
    }

    if (scrollBottomBtn) {
      scrollBottomBtn.onclick = () => {
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
      };
    }

  </script>
</body>

</html>
