<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trang Tu Táº­p NÃ¢ng Cáº¥p</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome for icons -->
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <!-- Google Fonts - Inter for a modern look -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Custom selection style */
    ::selection {
      background: gold;
      color: black;
    }

    /* Active state for Table of Contents links */
    .toc-active {
      font-weight: bold;
      color: #f59e0b; /* Tailwind yellow-500 */
    }

    /* Rain heart animation for like button */
    .rain-heart {
      position: absolute;
      animation: fall 1s ease-out forwards;
      pointer-events: none; /* Allow clicks to pass through */
      z-index: 10000; /* Ensure hearts are on top */
    }

    @keyframes fall {
      0% {
        opacity: 1;
        transform: translateY(-10px) scale(1);
      }
      100% {
        opacity: 0;
        transform: translateY(100px) scale(0.5);
      }
    }

    /* Highlight for search functionality */
    .highlight {
      background-color: yellow;
      padding: 2px 0;
    }

    /* Highlight for current reading paragraph */
    .highlight-paragraph {
      background-color: #fffacd; /* Light yellow for highlighting */
      transition: background-color 0.3s ease;
      padding: 0.25em 0.5em; /* Add some padding for better visual */
      border-radius: 0.25em; /* Rounded corners for highlight */
      display: block; /* Ensure it takes full width */
    }

    /* Dark mode adjustment for highlight */
    body.dark .highlight-paragraph {
      background-color: #3a3f4a; /* Darker shade for contrast in dark mode */
    }

    /* Smooth scroll behavior */
    html {
      scroll-behavior: smooth;
    }

    /* Apply Inter font globally */
    body {
      font-family: 'Inter', sans-serif;
    }

    /* Dark mode styles (applied on top of themes) */
    body.dark {
      background-color: #1a202c; /* Tailwind gray-900 */
      color: #e2e8f0; /* Tailwind gray-200 */
    }

    body.dark .bg-white {
      background-color: #2d3748; /* Tailwind gray-800 */
    }

    body.dark .text-gray-900 {
      color: #e2e8f0;
    }

    body.dark .bg-yellow-200 {
      background-color: #4a5568; /* Tailwind gray-700 */
    }

    body.dark .text-yellow-900 {
      color: #f6e05e; /* Tailwind yellow-300 */
    }

    body.dark .bg-gray-200 {
      background-color: #4a5568;
      color: #e2e8f0;
    }

    body.dark .bg-gray-300 {
      background-color: #6a7382;
    }

    body.dark #shareModal > div {
      background-color: #2d3748;
    }

    /* --- New Theme Styles --- */

    /* Xanh Lá»¥c TÄ©nh Láº·ng (Serene Green) */
    body.theme-green {
      background-color: #e0f2f7; /* Light Cyan */
      color: #2f4f4f; /* Dark Slate Gray */
    }
    body.theme-green .bg-yellow-200 {
      background-color: #a7d9d9; /* Lighter Teal */
    }
    body.theme-green .text-yellow-900 {
      color: #2f4f4f;
    }
    body.theme-green .bg-gray-50 {
      background-color: #c0e0e0; /* Light Teal */
    }
    body.theme-green .bg-gray-200 {
      background-color: #80ced6; /* Medium Teal */
    }
    body.theme-green .text-gray-800 {
      color: #2f4f4f;
    }
    body.theme-green .bg-gray-700 {
      background-color: #5f9ea0; /* Cadet Blue */
    }
    body.theme-green .bg-pink-500 {
      background-color: #ffb6c1; /* Light Pink for contrast */
    }
    body.theme-green .bg-blue-600 {
      background-color: #6495ed; /* Cornflower Blue for contrast */
    }
    body.theme-green #shareModal > div {
      background-color: #e0f2f7;
    }
    body.theme-green #content {
      background-color: #d4f0f0; /* Slightly darker light cyan for content */
    }

    /* TÃ­m Thiá»n Äá»‹nh (Meditative Purple) */
    body.theme-purple {
      background-color: #f0e6fa; /* Lavender Blush */
      color: #4b0082; /* Indigo */
    }
    body.theme-purple .bg-yellow-200 {
      background-color: #d8bfd8; /* Thistle */
    }
    body.theme-purple .text-yellow-900 {
      color: #4b0082;
    }
    body.theme-purple .bg-gray-50 {
      background-color: #e6cce6; /* Plum */
    }
    body.theme-purple .bg-gray-200 {
      background-color: #b0e0e6; /* Powder Blue (for contrast) */
    }
    body.theme-purple .text-gray-800 {
      color: #4b0082;
    }
    body.theme-purple .bg-gray-700 {
      background-color: #9370db; /* Medium Purple */
    }
    body.theme-purple .bg-pink-500 {
      background-color: #ff69b4; /* Hot Pink for contrast */
    }
    body.theme-purple .bg-blue-600 {
      background-color: #8a2be2; /* Blue Violet for contrast */
    }
    body.theme-purple #shareModal > div {
      background-color: #f0e6fa;
    }
    body.theme-purple #content {
      background-color: #e8d0f2; /* Slightly darker lavender for content */
    }

    /* VÃ ng Nháº¹ ThoÃ¡t Tá»¥c (Subtle Yellow/Gold) */
    body.theme-gold {
      background-color: #fffaf0; /* Floral White */
      color: #5a4a3a; /* Darker Brown */
    }
    body.theme-gold .bg-yellow-200 {
      background-color: #ffe4b5; /* Moccasin */
    }
    body.theme-gold .text-yellow-900 {
      color: #5a4a3a;
    }
    body.theme-gold .bg-gray-50 {
      background-color: #fffacd; /* Lemon Chiffon */
    }
    body.theme-gold .bg-gray-200 {
      background-color: #f0e68c; /* Khaki */
    }
    body.theme-gold .text-gray-800 {
      color: #5a4a3a;
    }
    body.theme-gold .bg-gray-700 {
      background-color: #daa520; /* Goldenrod */
    }
    body.theme-gold .bg-pink-500 {
      background-color: #ffc0cb; /* Pink for contrast */
    }
    body.theme-gold .bg-blue-600 {
      background-color: #add8e6; /* Light Blue for contrast */
    }
    body.theme-gold #shareModal > div {
      background-color: #fffaf0;
    }
    body.theme-gold #content {
      background-color: #fff5e0; /* Slightly darker floral white for content */
    }
  </style>
</head>

<body class="bg-white text-gray-900 transition-all duration-300">
  <!-- Scroll Progress Bar -->
  <div id="scrollProgress" class="fixed top-0 left-0 h-1 bg-yellow-400 z-[9999]" style="width: 0%;"></div>

  <!-- Navigation Header -->
  <header class="bg-yellow-200 shadow sticky top-0 z-50 rounded-b-lg">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="text-xl font-bold text-yellow-900">ğŸŒ Minh SÆ° Tá»‹nh Quang</div>
      <nav class="hidden md:flex space-x-4 text-sm">
        <a href="#" class="hover:underline p-2 rounded-lg hover:bg-yellow-300 transition-colors duration-200">Trang chá»§</a>
        <a href="#" class="hover:underline p-2 rounded-lg hover:bg-yellow-300 transition-colors duration-200">Play Nháº¡c</a>
        <a href="#" class="hover:underline p-2 rounded-lg hover:bg-yellow-300 transition-colors duration-200">Kho ThÆ¡</a>
        <a href="#" class="hover:underline p-2 rounded-lg hover:bg-yellow-300 transition-colors duration-200">Play Video</a>
        <a href="https://facebook.com" target="_blank" class="hover:underline p-2 rounded-lg hover:bg-yellow-300 transition-colors duration-200">Facebook</a>
        <a href="https://youtube.com" target="_blank" class="hover:underline p-2 rounded-lg hover:bg-yellow-300 transition-colors duration-200">YouTube</a>
      </nav>
      <button id="menuToggle" class="md:hidden text-yellow-900 p-2 rounded-lg hover:bg-yellow-300 transition-colors duration-200">
        <i class="fas fa-bars text-2xl"></i>
      </button>
    </div>
  </header>

  <!-- Mobile Menu -->
  <div id="mobileMenu" class="fixed inset-0 bg-white z-[999] p-6 hidden flex-col space-y-4 rounded-lg shadow-lg">
    <button id="closeMenu" class="self-end text-yellow-900 p-2 rounded-lg hover:bg-yellow-100 transition-colors duration-200"><i class="fas fa-times text-2xl"></i></button>
    <a href="#" class="hover:underline p-2 rounded-lg hover:bg-yellow-100 transition-colors duration-200">Trang chá»§</a>
    <a href="#" class="hover:underline p-2 rounded-lg hover:bg-yellow-100 transition-colors duration-200">Play Nháº¡c</a>
    <a href="#" class="hover:underline p-2 rounded-lg hover:bg-yellow-100 transition-colors duration-200">Kho ThÆ¡</a>
    <a href="#" class="hover:underline p-2 rounded-lg hover:bg-yellow-100 transition-colors duration-200">Play Video</a>
    <a href="https://facebook.com" target="_blank" class="hover:underline p-2 rounded-lg hover:bg-yellow-100 transition-colors duration-200">Facebook</a>
    <a href="https://youtube.com" target="_blank" class="hover:underline p-2 rounded-lg hover:bg-yellow-100 transition-colors duration-200">YouTube</a>
  </div>

  <!-- Table of Contents (TOC) -->
  <aside class="hidden lg:block fixed left-4 top-24 w-56 text-sm bg-gray-50 p-4 rounded-lg shadow-md" id="toc">
    <h3 class="font-bold text-lg mb-2 text-yellow-800">Má»¥c Lá»¥c</h3>
    <!-- TOC links will be dynamically inserted here -->
  </aside>

  <main class="container mx-auto px-4 py-8 max-w-3xl relative">
    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
      <div class="flex gap-2">
        <button id="readBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 shadow-md">
          ğŸ”Š Äá»c bÃ i
        </button>
        <button id="likeBtn" class="relative px-4 py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600 transition-colors duration-200 shadow-md">
          â¤ï¸ <span id="likeCount">0</span>
        </button>
        <button id="shareBtn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors duration-200 shadow-md">
          ğŸ“¤ Chia sáº»
        </button>
      </div>
      <div class="flex gap-2 items-center">
        <input type="text" id="searchBox" placeholder="TÃ¬m kiáº¿m..." class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 transition-all duration-200 w-full sm:w-auto">
        <button id="searchBtn" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors duration-200 shadow-md">
          ğŸ”
        </button>
        <select id="themeSelector" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 transition-all duration-200">
          <option value="default">Máº·c Ä‘á»‹nh</option>
          <option value="green">Xanh Lá»¥c TÄ©nh Láº·ng</option>
          <option value="purple">TÃ­m Thiá»n Äá»‹nh</option>
          <option value="gold">VÃ ng Nháº¹ ThoÃ¡t Tá»¥c</option>
        </select>
        <button id="darkModeToggle" class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800 transition-colors duration-200 shadow-md">
          ğŸŒ™
        </button>
      </div>
    </div>

    <!-- Main Content Area -->
    <div id="content" class="prose lg:prose-lg max-w-none bg-white p-6 rounded-lg shadow-xl">
      <h1 id="section-0">Ãnh sÃ¡ng vÃ  sá»± sá»‘ng trong tu táº­p</h1>
      <p><strong>Má»Ÿ Ä‘áº§u:</strong> Trong muÃ´n loÃ i váº¡n váº­t, Ã¡nh sÃ¡ng chÃ­nh lÃ  nguá»“n gá»‘c cá»§a sá»± sá»‘ng, lÃ  yáº¿u tá»‘ thiáº¿t yáº¿u nuÃ´i dÆ°á»¡ng má»i sinh linh. Tá»« Ã¡nh náº¯ng máº·t trá»i rá»±c rá»¡ ban ngÃ y Ä‘áº¿n Ã¡nh trÄƒng dá»‹u mÃ¡t Ä‘Ãªm vá», hay Ã¡nh sao láº¥p lÃ¡nh trÃªn báº§u trá»i, táº¥t cáº£ Ä‘á»u mang theo má»™t thÃ´ng Ä‘iá»‡p vá» sá»± tá»“n táº¡i, vá» nÄƒng lÆ°á»£ng vÃ  sá»± phÃ¡t triá»ƒn. Trong con Ä‘Æ°á»ng tu táº­p tÃ¢m linh, Ã¡nh sÃ¡ng khÃ´ng chá»‰ lÃ  má»™t hiá»‡n tÆ°á»£ng váº­t lÃ½ mÃ  cÃ²n lÃ  biá»ƒu tÆ°á»£ng sÃ¢u sáº¯c cho trÃ­ tuá»‡, sá»± giÃ¡c ngá»™ vÃ  nÄƒng lÆ°á»£ng thiÃªng liÃªng. NÃ³ lÃ  kim chá»‰ nam dáº«n lá»‘i, lÃ  nguá»“n sá»©c máº¡nh ná»™i táº¡i giÃºp ngÆ°á»i hÃ nh giáº£ vÆ°á»£t qua má»i chÆ°á»›ng ngáº¡i, hÆ°á»›ng tá»›i sá»± hoÃ n thiá»‡n.</p>

      <h2 id="section-1">Ãnh sÃ¡ng ná»™i tÃ¢m: Ná»n táº£ng cá»§a sá»± giÃ¡c ngá»™</h2>
      <p>Khi ngÆ°á»i hÃ nh giáº£ bÆ°á»›c vÃ o con Ä‘Æ°á»ng tu há»c, Ä‘iá»u Ä‘áº§u tiÃªn cáº§n nháº­n thá»©c lÃ  táº§m quan trá»ng cá»§a Ã¡nh sÃ¡ng ná»™i tÃ¢m. Ãnh sÃ¡ng nÃ y khÃ´ng pháº£i lÃ  thá»© cÃ³ thá»ƒ nhÃ¬n tháº¥y báº±ng máº¯t thÆ°á»ng, mÃ  lÃ  sá»± minh triáº¿t, sá»± hiá»ƒu biáº¿t sÃ¢u sáº¯c vá» báº£n cháº¥t cá»§a váº¡n váº­t vÃ  vá» chÃ­nh mÃ¬nh. NÃ³ lÃ  sá»± thá»©c tá»‰nh cá»§a lÆ°Æ¡ng tri, lÃ  kháº£ nÄƒng phÃ¢n biá»‡t thiá»‡n Ã¡c, Ä‘Ãºng sai, lÃ  sá»± nháº­n diá»‡n chÃ¢n lÃ½ trong tá»«ng hÆ¡i thá»Ÿ, tá»«ng Ã½ niá»‡m. Viá»‡c nuÃ´i dÆ°á»¡ng Ã¡nh sÃ¡ng ná»™i tÃ¢m Ä‘Ã²i há»i sá»± kiÃªn trÃ¬, tinh táº¥n trong thiá»n Ä‘á»‹nh, quÃ¡n chiáº¿u vÃ  thá»±c hÃ nh giá»›i luáº­t. Má»—i khi má»™t phiá»n nÃ£o Ä‘Æ°á»£c hÃ³a giáº£i, má»™t cháº¥p trÆ°á»›c Ä‘Æ°á»£c buÃ´ng bá», Ã¡nh sÃ¡ng trong tÃ¢m láº¡i cÃ ng rá»±c rá»¡ hÆ¡n, soi rá»i rÃµ rÃ ng hÆ¡n con Ä‘Æ°á»ng phÃ­a trÆ°á»›c.</p>

      <h2 id="section-2">VÆ°á»£t qua bÃ³ng tá»‘i: Nhá»¯ng chÆ°á»›ng ngáº¡i trÃªn con Ä‘Æ°á»ng tu</h2>
      <p>Thiáº¿u Ã¡nh sÃ¡ng, con Ä‘Æ°á»ng tu trá»Ÿ nÃªn má» má»‹t, Ä‘áº§y ráº«y nhá»¯ng cáº¡m báº«y vÃ  thá»­ thÃ¡ch. BÃ³ng tá»‘i á»Ÿ Ä‘Ã¢y khÃ´ng chá»‰ lÃ  sá»± vÃ´ minh, mÃ  cÃ²n lÃ  nhá»¯ng tham lam, sÃ¢n háº­n, si mÃª, lÃ  nhá»¯ng dá»¥c vá»ng tráº§n tá»¥c nÃ­u kÃ©o. Khi tÃ¢m trÃ­ bá»‹ che phá»§ bá»Ÿi bÃ³ng tá»‘i, ngÆ°á»i tu dá»… dÃ ng láº¡c lá»‘i, máº¥t phÆ°Æ¡ng hÆ°á»›ng, tháº­m chÃ­ tá»« bá» con Ä‘Æ°á»ng Ä‘Ã£ chá»n. Nhá»¯ng lÃºc nhÆ° váº­y, Ã¡nh sÃ¡ng cá»§a chÃ¡nh phÃ¡p, Ã¡nh sÃ¡ng tá»« sá»± hÆ°á»›ng dáº«n cá»§a Minh SÆ°, vÃ  Ã¡nh sÃ¡ng tá»« sá»± kiÃªn Ä‘á»‹nh cá»§a chÃ­nh mÃ¬nh trá»Ÿ thÃ nh ngá»n háº£i Ä‘Äƒng, giÃºp ngÆ°á»i hÃ nh giáº£ vÆ°á»£t qua bÃ£o tá»‘. Viá»‡c Ä‘á»‘i diá»‡n vÃ  chuyá»ƒn hÃ³a bÃ³ng tá»‘i lÃ  má»™t pháº§n khÃ´ng thá»ƒ thiáº¿u cá»§a quÃ¡ trÃ¬nh tu táº­p, bá»Ÿi chá»‰ khi vÆ°á»£t qua Ä‘Æ°á»£c nhá»¯ng giá»›i háº¡n cá»§a báº£n thÃ¢n, Ã¡nh sÃ¡ng má»›i cÃ³ thá»ƒ tá»a ráº¡ng má»™t cÃ¡ch trá»n váº¹n.</p>

      <h2 id="section-3">PhÃ¡p mÃ´n Minh SÆ° Tá»‹nh Quang: Nguá»“n sÃ¡ng dáº«n lá»‘i</h2>
      <p>Trong PhÃ¡p mÃ´n Minh SÆ° Tá»‹nh Quang, Ã¡nh sÃ¡ng Ä‘Æ°á»£c xem lÃ  má»™t yáº¿u tá»‘ cá»‘t lÃµi, lÃ  phÆ°Æ¡ng tiá»‡n Ä‘á»ƒ Ä‘áº¡t Ä‘áº¿n sá»± thanh tá»‹nh vÃ  giÃ¡c ngá»™. Minh SÆ°, vá»›i trÃ­ tuá»‡ vÃ  lÃ²ng tá»« bi vÃ´ háº¡n, chÃ­nh lÃ  hiá»‡n thÃ¢n cá»§a Ã¡nh sÃ¡ng, lÃ  ngÆ°á»i tháº§y dáº«n dáº¯t chÃºng sinh thoÃ¡t khá»i vÃ´ minh. PhÃ¡p mÃ´n nÃ y nháº¥n máº¡nh viá»‡c tu táº­p Ä‘á»ƒ khai má»Ÿ "Tá»‹nh Quang" â€“ Ã¡nh sÃ¡ng thanh tá»‹nh bÃªn trong má»—i ngÆ°á»i. ThÃ´ng qua viá»‡c thá»±c hÃ nh cÃ¡c phÃ¡p mÃ´n Ä‘áº·c thÃ¹, ngÆ°á»i tu há»c Ä‘Æ°á»£c tiáº¿p nháº­n vÃ  dung hÃ²a Ã¡nh sÃ¡ng tá»« Minh SÆ°, tá»« Ä‘Ã³ lÃ m tÄƒng trÆ°á»Ÿng Ã¡nh sÃ¡ng ná»™i tÃ¢m cá»§a chÃ­nh mÃ¬nh. Sá»± káº¿t ná»‘i vá»›i Tá»‹nh Quang khÃ´ng chá»‰ giÃºp thanh lá»c thÃ¢n tÃ¢m mÃ  cÃ²n má»Ÿ ra nhá»¯ng táº§ng nháº­n thá»©c cao hÆ¡n, Ä‘Æ°a ngÆ°á»i hÃ nh giáº£ Ä‘áº¿n gáº§n hÆ¡n vá»›i chÃ¢n lÃ½ tá»‘i thÆ°á»£ng.</p>

      <h2 id="section-4">Sá»± sá»‘ng má»›i: Káº¿t quáº£ cá»§a Ã¡nh sÃ¡ng tu táº­p</h2>
      <p>Khi Ã¡nh sÃ¡ng ná»™i tÃ¢m Ä‘Æ°á»£c nuÃ´i dÆ°á»¡ng vÃ  phÃ¡t triá»ƒn, nÃ³ khÃ´ng chá»‰ mang láº¡i sá»± bÃ¬nh an, háº¡nh phÃºc cho báº£n thÃ¢n mÃ  cÃ²n lan tá»a ra xung quanh, áº£nh hÆ°á»Ÿng tÃ­ch cá»±c Ä‘áº¿n cuá»™c sá»‘ng cá»§a nhá»¯ng ngÆ°á»i khÃ¡c. Sá»± sá»‘ng trong tu táº­p khÃ´ng chá»‰ lÃ  sá»± tá»“n táº¡i vá» máº·t thá»ƒ xÃ¡c, mÃ  lÃ  má»™t cuá»™c sá»‘ng trÃ n Ä‘áº§y Ã½ nghÄ©a, má»¥c Ä‘Ã­ch vÃ  lÃ²ng tá»« bi. NgÆ°á»i tu há»c vá»›i Ã¡nh sÃ¡ng rá»±c rá»¡ trong tÃ¢m sáº½ trá»Ÿ thÃ nh nguá»“n cáº£m há»©ng, lÃ  táº¥m gÆ°Æ¡ng sÃ¡ng cho cá»™ng Ä‘á»“ng. Há» sá»‘ng má»™t cuá»™c Ä‘á»i vá»‹ tha, cá»‘ng hiáº¿n, vÃ  luÃ´n hÆ°á»›ng Ä‘áº¿n sá»± thiá»‡n lÃ nh. ÄÃ¢y chÃ­nh lÃ  biá»ƒu hiá»‡n cao nháº¥t cá»§a sá»± sá»‘ng Ä‘Æ°á»£c nuÃ´i dÆ°á»¡ng bá»Ÿi Ã¡nh sÃ¡ng cá»§a trÃ­ tuá»‡ vÃ  tÃ¬nh yÃªu thÆ°Æ¡ng.</p>

      <p><strong>Káº¿t luáº­n:</strong> HÃ£y gÃ¬n giá»¯ vÃ  nuÃ´i dÆ°á»¡ng Ã¡nh sÃ¡ng trong tÃ¢m, bá»Ÿi Ä‘Ã³ lÃ  nguá»“n gá»‘c cá»§a má»i sá»± sá»‘ng vÃ  lÃ  con Ä‘Æ°á»ng dáº«n Ä‘áº¿n sá»± giÃ¡c ngá»™ viÃªn mÃ£n. Ãnh sÃ¡ng khÃ´ng chá»‰ lÃ  biá»ƒu tÆ°á»£ng mÃ  cÃ²n lÃ  nÄƒng lÆ°á»£ng thá»±c sá»±, giÃºp chÃºng ta vÆ°á»£t qua bÃ³ng tá»‘i vÃ´ minh, sá»‘ng má»™t cuá»™c Ä‘á»i Ã½ nghÄ©a vÃ  lan tá»a yÃªu thÆ°Æ¡ng Ä‘áº¿n muÃ´n nÆ¡i. PhÃ¡p mÃ´n Minh SÆ° Tá»‹nh Quang chÃ­nh lÃ  chiáº¿c thuyá»n Ä‘Æ°a chÃºng ta Ä‘áº¿n báº¿n bá» giÃ¡c ngá»™, nÆ¡i Ã¡nh sÃ¡ng vÄ©nh cá»­u soi rá»i má»i ngÃ³c ngÃ¡ch cá»§a tÃ¢m há»“n.</p>
    </div>
  </main>

  <!-- Share Modal -->
  <div id="shareModal" class="fixed inset-0 bg-black/40 flex justify-center items-center z-[9999] hidden">
    <div class="bg-white p-6 rounded-lg shadow-xl w-80">
      <h2 class="text-lg font-bold mb-4 text-gray-800">Chia sáº»</h2>
      <div class="flex flex-col gap-3 mb-4">
        <a href="#" id="shareFacebook" target="_blank" class="flex items-center gap-2 text-blue-600 hover:underline p-2 rounded-lg hover:bg-blue-50 transition-colors duration-200">
          <i class="fab fa-facebook-f"></i> Facebook
        </a>
        <button id="copyLinkBtn" class="flex items-center gap-2 text-green-600 hover:underline p-2 rounded-lg hover:bg-green-50 transition-colors duration-200 justify-start">
          <i class="fas fa-link"></i> Sao chÃ©p liÃªn káº¿t
        </button>
      </div>
      <button id="closeShare" class="block mx-auto bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors duration-200 shadow-md">ÄÃ³ng</button>
    </div>
  </div>

  <!-- Message Box for copy confirmation -->
  <div id="messageBox" class="fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg hidden z-[10000]">
    ÄÃ£ sao chÃ©p vÃ o clipboard!
  </d>

  <script type="module">
    // Firebase imports (using modular SDK)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global variables for Firebase config and auth token
    const firebaseConfig = {
      apiKey: "AIzaSyAYDG6sVKYbLBzO_iQGwoK9FTH8deJVo3s",
      authDomain: "giaoly-editor.firebaseapp.com",
      projectId: "giaoly-editor",
      storageBucket: "giaoly-editor.firebasestorage.app",
      messagingSenderId: "62184116846",
      appId: "1:62184116846:web:5bd50b4f8a433a066bcc7f",
      measurementId: "G-56PKNCYV6D"
    };

    const appId = firebaseConfig.projectId;
    const initialAuthToken = null;

    let app, db, auth, userId;
    const ARTICLE_ID = 'mainArticleLikes';
    let currentLikeCount = 0;

    // Log Firebase Config and App ID for debugging
    console.log("Firebase Config:", firebaseConfig);
    console.log("App ID for Firestore paths:", appId);

    // --- Helper Functions (Defined before they are called) ---

    // Message Box Display
    function showMessageBox(message) {
      const messageBox = document.getElementById('messageBox'); // Ensure messageBox is accessed here
      if (messageBox) {
        messageBox.textContent = message;
        messageBox.classList.remove('hidden');
        setTimeout(() => {
          messageBox.classList.add('hidden');
        }, 3000); // Hide after 3 seconds
      } else {
        console.warn("Message box element not found.");
      }
    }

    // Clear highlights for search functionality
    let lastHighlightedRanges = []; // Keep this global as it's modified by searchBtn.onclick

    function clearHighlights() {
      const content = document.getElementById('content'); // Ensure content is accessed here
      if (content) {
        const highlights = content.querySelectorAll('.highlight');
        highlights.forEach(span => {
          const parent = span.parentNode;
          while (span.firstChild) {
            parent.insertBefore(span.firstChild, span);
          }
          parent.removeChild(span);
        });
        content.normalize(); // Normalize the parent to merge adjacent text nodes
        lastHighlightedRanges = [];
      }
    }

    // Apply Theme Logic
    const themes = ['default', 'green', 'purple', 'gold'];

    const applyTheme = (themeName) => {
      themes.forEach(theme => {
        document.body.classList.remove(`theme-${theme}`);
      });
      if (themeName !== 'default') {
        document.body.classList.add(`theme-${themeName}`);
      }
      localStorage.setItem('selectedTheme', themeName);
    };

    // Text-to-Speech Helper Functions
    let speechSynthesizer = null;
    let paragraphElements = [];
    let currentParagraphIndex = 0;
    let currentUtterance = null;
    let isSpeechReady = false;

    function initializeParagraphElements() {
      const content = document.getElementById('content'); // Ensure content is accessed here
      if (content) {
        paragraphElements = Array.from(content.querySelectorAll('h1, h2, p'));
      }
    }

    const initSpeechSynthesis = () => {
      speechSynthesizer = window.speechSynthesis;
      const readBtn = document.getElementById('readBtn'); // Ensure readBtn is accessed here
      if (speechSynthesizer && readBtn) {
        speechSynthesizer.onvoiceschanged = () => {
          isSpeechReady = true;
          console.log("SpeechSynthesis voices loaded.");
        };
        if (speechSynthesizer.getVoices().length > 0) {
          isSpeechReady = true;
          console.log("SpeechSynthesis voices already loaded.");
        }
      } else if (readBtn) {
        console.warn("SpeechSynthesis not supported in this browser.");
        showMessageBox("TrÃ¬nh duyá»‡t cá»§a báº¡n khÃ´ng há»— trá»£ Ä‘á»c vÄƒn báº£n.");
        readBtn.disabled = true;
      }
    };

    function clearAllHighlightsForSpeech() { // Renamed to avoid conflict with search highlight clear
      paragraphElements.forEach(el => el.classList.remove('highlight-paragraph'));
    }

    function stopReading() {
      const readBtn = document.getElementById('readBtn'); // Ensure readBtn is accessed here
      if (speechSynthesizer && readBtn) {
        speechSynthesizer.cancel();
      }
      clearAllHighlightsForSpeech();
      currentParagraphIndex = 0;
      if (readBtn) readBtn.textContent = 'ğŸ”Š Äá»c bÃ i';
    }

    function startReading() {
      const readBtn = document.getElementById('readBtn'); // Ensure readBtn is accessed here
      clearAllHighlightsForSpeech();

      if (currentParagraphIndex >= paragraphElements.length) {
        stopReading();
        return;
      }

      const currentElement = paragraphElements[currentParagraphIndex];
      currentElement.classList.add('highlight-paragraph');
      currentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });

      currentUtterance = new SpeechSynthesisUtterance(currentElement.innerText);

      const voices = speechSynthesizer.getVoices();
      const vietnameseVoice = voices.find(voice => voice.lang === 'vi-VN');
      if (vietnameseVoice) {
        currentUtterance.voice = vietnameseVoice;
      } else {
        console.warn("Vietnamese voice not found. Using default voice.");
      }

      currentUtterance.onend = () => {
        currentElement.classList.remove('highlight-paragraph');
        currentParagraphIndex++;
        startReading();
      };

      currentUtterance.onerror = (event) => {
        console.error('SpeechSynthesisUtterance.onerror', event);
        stopReading();
        showMessageBox("Lá»—i khi Ä‘á»c bÃ i viáº¿t.");
      };

      speechSynthesizer.speak(currentUtterance);
      if (readBtn) readBtn.textContent = 'â¸ï¸ Táº¡m dá»«ng';
    }

    // Function to update active TOC link based on scroll position
    const updateTocActive = () => {
      const tocLinks = []; // Re-initialize or pass as argument if needed globally
      const headers = document.getElementById('content').querySelectorAll('h1, h2');
      headers.forEach((header, i) => {
        const id = 'section-' + i;
        const link = document.querySelector(`#toc a[href="#${id}"]`); // Find existing link
        if (link) {
          tocLinks.push({ id, link, element: header });
        }
      });

      let currentActive = null;
      for (let i = tocLinks.length - 1; i >= 0; i--) {
        const { element, link } = tocLinks[i];
        const rect = element.getBoundingClientRect();
        if (rect.top <= window.innerHeight / 2) {
          currentActive = link;
          break;
        }
      }
      tocLinks.forEach(({ link }) => link.classList.remove('toc-active'));
      if (currentActive) {
        currentActive.classList.add('toc-active');
      }
    };

    // Setup Real-time Likes Listener (moved to top for definition before call)
    const setupLikesListener = () => {
      if (!db) {
        console.warn("Firestore not ready for likes listener.");
        return;
      }
      const articleRef = doc(db, `favorites`, ARTICLE_ID);
      console.log("Firestore listener path (read):", articleRef.path);

      onSnapshot(articleRef, (docSnap) => {
        const likeCountSpan = document.getElementById('likeCount'); // Ensure likeCountSpan is accessed here
        if (docSnap.exists()) {
          currentLikeCount = docSnap.data().likes || 0;
        } else {
          currentLikeCount = 0;
          // TÃ¹y chá»n: Khá»Ÿi táº¡o tÃ i liá»‡u lÆ°á»£t thÃ­ch náº¿u nÃ³ chÆ°a tá»“n táº¡i.
          // Äiá»u nÃ y Ä‘áº£m báº£o tÃ i liá»‡u tá»“n táº¡i cho lÆ°á»£t thÃ­ch Ä‘áº§u tiÃªn.
          setDoc(articleRef, { likes: 0 }, { merge: true }).catch(e => console.error("Error initializing likes document:", e));
        }
        if (likeCountSpan) likeCountSpan.textContent = currentLikeCount;
        console.log("Current like count:", currentLikeCount);
      }, (error) => {
        console.error("Error listening to likes:", error);
        showMessageBox("Lá»—i khi táº£i sá»‘ lÆ°á»£t thÃ­ch. Vui lÃ²ng kiá»ƒm tra káº¿t ná»‘i máº¡ng.");
      });
    };


    // --- Initialize Firebase and handle authentication ---
    const initFirebase = async () => {
      try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        if (initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
          console.log("Signed in with custom token.");
        } else {
          await signInAnonymously(auth);
          console.log("Signed in anonymously.");
        }

        onAuthStateChanged(auth, (user) => {
          if (user) {
            userId = user.uid;
            console.log("User ID:", userId);
            setupLikesListener(); // Call after user is authenticated
          } else {
            console.log("No user is signed in.");
            userId = null;
            setupLikesListener(); // Still call to load public likes even if anonymous
          }
        });
      } catch (error) {
        console.error("Error initializing Firebase or signing in:", error);
        showMessageBox("Lá»—i khá»Ÿi táº¡o Firebase. Vui lÃ²ng kiá»ƒm tra cáº¥u hÃ¬nh API Key vÃ  cÃ¡c thÃ´ng sá»‘ khÃ¡c.");
      }
    };

    // Call Firebase initialization
    initFirebase();


    // --- DOM Elements ---
    const menuToggle = document.getElementById('menuToggle');
    const mobileMenu = document.getElementById('mobileMenu');
    const closeMenu = document.getElementById('closeMenu');
    const toc = document.getElementById('toc');
    const content = document.getElementById('content');
    const scrollProgress = document.getElementById('scrollProgress');
    const readBtn = document.getElementById('readBtn');
    const likeBtn = document.getElementById('likeBtn');
    const likeCountSpan = document.getElementById('likeCount');
    const shareBtn = document.getElementById('shareBtn');
    const shareModal = document.getElementById('shareModal');
    const closeShare = document.getElementById('closeShare');
    const shareFacebook = document.getElementById('shareFacebook');
    const copyLinkBtn = document.getElementById('copyLinkBtn'); // Corrected from 'document = document.getElementById'
    const messageBox = document.getElementById('messageBox');
    const searchBox = document.getElementById('searchBox');
    const searchBtn = document.getElementById('searchBtn');
    const darkModeToggle = document.getElementById('darkModeToggle');
    const themeSelector = document.getElementById('themeSelector');


    // --- Event Listeners ---

    // Mobile Menu Toggle
    if (menuToggle) menuToggle.onclick = () => mobileMenu.classList.remove('hidden');
    if (closeMenu) closeMenu.onclick = () => mobileMenu.classList.add('hidden');

    // Table of Contents (TOC) Generation and Highlighting
    // This part needs to run after content is loaded
    window.addEventListener('DOMContentLoaded', () => {
      const headers = content.querySelectorAll('h1, h2');
      const tocLinksArray = []; // Use a local array for TOC generation
      headers.forEach((header, i) => {
        const id = 'section-' + i;
        header.id = id;
        const link = document.createElement('a');
        link.href = '#' + id;
        link.textContent = header.textContent;
        link.className = 'block py-1 px-2 rounded-md hover:bg-yellow-100 transition-colors duration-200';
        if (toc) toc.appendChild(link);
        tocLinksArray.push({ id, link, element: header }); // Store for updateTocActive

        link.addEventListener('click', (e) => {
          e.preventDefault();
          header.scrollIntoView({ behavior: 'smooth' });
          setTimeout(() => updateTocActive(), 600);
        });
      });
      // Re-assign tocLinks global variable after generation
      // This is a bit tricky with global `tocLinks` and local `tocLinksArray`.
      // For simplicity, I'll keep `tocLinks` as a global variable and populate it directly.
      // The `updateTocActive` function will then correctly iterate over it.
    });


    // Scroll Progress Bar
    window.onscroll = () => {
      if (scrollProgress) {
        const scrolled = (window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100;
        scrollProgress.style.width = scrolled + '%';
      }
      updateTocActive();
    };

    // Text-to-Speech (Read Article) Click Handler
    if (readBtn) {
      readBtn.onclick = () => {
        if (!isSpeechReady) {
          showMessageBox("Äang táº£i giá»ng Ä‘á»c, vui lÃ²ng thá»­ láº¡i sau giÃ¢y lÃ¡t.");
          return;
        }
        if (speechSynthesizer.speaking && !speechSynthesizer.paused) {
          speechSynthesizer.pause();
          readBtn.textContent = 'â–¶ï¸ Tiáº¿p tá»¥c';
          return;
        }
        if (speechSynthesizer.paused) {
          speechSynthesizer.resume();
          readBtn.textContent = 'â¸ï¸ Táº¡m dá»«ng';
          return;
        }
        startReading();
      };
    }


    // Like Button + Heart Rain Effect with Firestore
    if (likeBtn) {
      likeBtn.onclick = async (e) => {
        if (!db) {
          console.error("Firestore not initialized. Cannot update likes.");
          showMessageBox("Lá»—i: KhÃ´ng thá»ƒ káº¿t ná»‘i Ä‘áº¿n mÃ¡y chá»§. Vui lÃ²ng kiá»ƒm tra cáº¥u hÃ¬nh Firebase.");
          return;
        }
        const articleRef = doc(db, `favorites`, ARTICLE_ID);
        console.log("Firestore article likes path (write):", articleRef.path);

        try {
          await setDoc(articleRef, { likes: increment(1) }, { merge: true });
          console.log("Like count updated in Firestore.");
          const heart = document.createElement('div');
          heart.textContent = 'â¤ï¸';
          heart.className = 'rain-heart';
          const rect = likeBtn.getBoundingClientRect();
          heart.style.left = (e.clientX - rect.left + likeBtn.offsetWidth / 2 - 10) + 'px';
          heart.style.top = (e.clientY - rect.top + likeBtn.offsetHeight / 2 - 10) + 'px';
          likeBtn.appendChild(heart);
          setTimeout(() => heart.remove(), 1000);
        } catch (error) {
          console.error("Error updating like count:", error);
          showMessageBox("Lá»—i khi thÃ­ch bÃ i viáº¿t. Vui lÃ²ng kiá»ƒm tra quy táº¯c báº£o máº­t Firestore vÃ  káº¿t ná»‘i.");
        }
      };
    }


    // Share Modal
    if (shareBtn) {
      shareBtn.onclick = () => {
        if (shareModal) shareModal.classList.remove('hidden');
        const currentUrl = window.location.href;
        if (shareFacebook) shareFacebook.href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(currentUrl)}`;
      };
    }
    if (closeShare) closeShare.onclick = () => shareModal.classList.add('hidden');
    if (shareModal) {
      shareModal.addEventListener('click', (e) => {
        if (e.target === shareModal) {
          shareModal.classList.add('hidden');
        }
      });
    }


    // Copy Link Functionality
    if (copyLinkBtn) {
      copyLinkBtn.onclick = () => {
        const currentUrl = window.location.href;
        try {
          const tempInput = document.createElement('textarea');
          tempInput.value = currentUrl;
          document.body.appendChild(tempInput);
          tempInput.select();
          document.execCommand('copy');
          document.body.removeChild(tempInput);
          showMessageBox('ÄÃ£ sao chÃ©p vÃ o clipboard!');
          if (shareModal) shareModal.classList.add('hidden');
        } catch (err) {
          console.error('Failed to copy text: ', err);
          showMessageBox('Sao chÃ©p tháº¥t báº¡i. Vui lÃ²ng sao chÃ©p thá»§ cÃ´ng.');
        }
      };
    }


    // Search and Highlight Functionality
    if (searchBtn) {
      searchBtn.onclick = () => {
        const searchTerm = searchBox.value.trim();
        if (searchTerm === '') {
          clearHighlights();
          return;
        }
        clearHighlights();
        const walker = document.createTreeWalker(content, NodeFilter.SHOW_TEXT, null, false);
        let node;
        let foundCount = 0;
        const rangesToHighlight = [];
        while ((node = walker.nextNode())) {
          const text = node.nodeValue;
          let startIndex = 0;
          while ((startIndex = text.toLowerCase().indexOf(searchTerm.toLowerCase(), startIndex)) !== -1) {
            const range = document.createRange();
            range.setStart(node, startIndex);
            range.setEnd(node, startIndex + searchTerm.length);
            rangesToHighlight.push(range);
            startIndex += searchTerm.length;
            foundCount++;
          }
        }
        if (foundCount > 0) {
          rangesToHighlight.forEach(range => {
            const span = document.createElement('span');
            span.classList.add('highlight');
            range.surroundContents(span);
          });
          lastHighlightedRanges = rangesToHighlight;
          showMessageBox(`TÃ¬m tháº¥y ${foundCount} káº¿t quáº£.`);
        } else {
          showMessageBox('KhÃ´ng tÃ¬m tháº¥y káº¿t quáº£ nÃ o.');
        }
      };
    }

    // Clear highlights when search box is cleared
    if (searchBox) {
      searchBox.addEventListener('input', () => {
        if (searchBox.value.trim() === '') {
          clearHighlights();
        }
      });
    }

    // Dark Mode Toggle
    if (darkModeToggle) {
      darkModeToggle.onclick = () => {
        document.body.classList.toggle('dark');
        if (document.body.classList.contains('dark')) {
          localStorage.setItem('theme', 'dark');
          darkModeToggle.innerHTML = 'â˜€ï¸';
        } else {
          localStorage.setItem('theme', 'light');
          darkModeToggle.innerHTML = 'ğŸŒ™';
        }
      };
    }


    // Apply saved theme and dark mode on load
    window.addEventListener('DOMContentLoaded', () => {
      const savedTheme = localStorage.getItem('selectedTheme');
      if (savedTheme) {
        applyTheme(savedTheme);
        if (themeSelector) themeSelector.value = savedTheme;
      } else {
        applyTheme('default');
        if (themeSelector) themeSelector.value = 'default';
      }

      const savedDarkMode = localStorage.getItem('theme');
      if (savedDarkMode === 'dark') {
        document.body.classList.add('dark');
        if (darkModeToggle) darkModeToggle.innerHTML = 'â˜€ï¸';
      } else {
        if (darkModeToggle) darkModeToggle.innerHTML = 'ğŸŒ™';
      }
    });

    // Event listener for theme selection change
    if (themeSelector) {
      themeSelector.onchange = (event) => {
        applyTheme(event.target.value);
      };
    }

    // Add an event listener to stop reading if the user navigates away or closes the tab
    window.addEventListener('beforeunload', () => {
      if (speechSynthesizer && speechSynthesizer.speaking) {
        speechSynthesizer.cancel();
      }
    });

  </script>
</body>

</html>
